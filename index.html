<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <title>ET423 WebFIS</title>
        <link rel="stylesheet" href="https://use.typekit.net/aav3vqj.css">
        <link rel="stylesheet" href="style.css">
        <script src="script.js"></script>
        <meta name="og:site_name" content="ET423 WebFIS">
        <meta name="og:type" content="website">
    </head>
    <body style="background-color: black;">
        <main style="width: 1900px; height: 535px; background-color: #ffffff; margin: auto;">
            <div style="width: 1900px; height: 535px; background-color: #ffffff; margin: auto; position: absolute;">
                <div style="height: 419px; width: 100%; display: flex;">
                    <div style="width: 1155px; height: 100%;">
                        <div style="height: 143px;display: flex;">
                            <div style="display: flex; width: 202px; font-family: 'myriad-pro-regular', sans-serif; font-size: 25px;">
                                <span id="plannedArrivalNextStop" style="padding-left: 20px; top: 52%; position: relative; height: fit-content;"></span>
                                <div style="position: relative; left: 8px;">
                                    <svg id="nextStopNextStop" style="display: none;" width="40" height="143" viewBox="0 0 40 143" version="1.1" xml:space="preserve"
                                    xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg">
                                        <g><rect
                                            style="fill:#ffffff;"
                                            class="lineStrokeColoured" width="6" height="37" x="17" y="106" />
                                            <rect
                                            style="fill:#999999;"
                                            width="6" height="64" x="17" y="0" />
                                            <circle
                                            style="fill:#ffffff;"
                                            class="lineStrokeColoured" cx="20" cy="91" r="11" />
                                            <path
                                            style="fill:#999999;"
                                            d="m 19.5,69.5 15,-15 L 31,51 19.5,62.5 Z m 0,0 -15,-15 L 8,51 19.5,62.5 Z" class="UnoptimicedTransforms"
                                            transform="translate(0.5)" />
                                        </g>
                                    </svg>
                                    <svg id="firstStopNextStop" style="display: none;" width="40" height="143" viewBox="0 0 40 143" version="1.1" xml:space="preserve"
                                    xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg">
                                        <g><rect
                                            class="lineStrokeColoured"
                                            style="fill:#ffffff;"
                                            width="6"
                                            height="57"
                                            x="17"
                                            y="86" /><rect
                                            class="lineStrokeColoured"
                                            style="fill:#ffffff;"
                                            width="24"
                                            height="6"
                                            x="8"
                                            y="83" />
                                        </g>
                                    </svg>
                                    <svg id="lastStopNextStop" style="display: none;" width="40" height="143" viewBox="0 0 40 143" version="1.1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs2" /><g id="g320" style="display:inline"> <rect style="fill:#999999;" width="6" height="64" x="17" y="0" /> <path style="fill:#999999;" d="m 19.5,69.5 15,-15 L 31,51 19.5,62.5 Z m 0,0 -15,-15 L 8,51 19.5,62.5 Z" class="UnoptimicedTransforms" transform="translate(0.5)" /> <rect style="fill:#ffffff;" class="lineStrokeColoured" width="6" height="16" x="17" y="75" /> <rect style="fill:#ffffff;" class="lineStrokeColoured" width="6" height="24" x="88" y="-32" transform="rotate(90)" /> </g>
                                    </svg> 
                                </div>
                                <span id="delayNextStop" style="padding-left: 10px; top: 52%; position: relative; height: fit-content;"></span>
                            </div>
                            <div style="height: 100%;">
                                <div style="width: 100%; font-size: 24px; font-family: 'myriad-pro', sans-serif; padding-top: 8px; padding-left: 2px;">
                                    <span id="stationActionDE" style="padding-right: 8px;"></span>
                                    <i id="stationActionEN" style="color: #666666;"></i>
                                    <span id="stationActionDepartureTime" style="padding-left: 18px;"></span>
                                </div>
                                <div id="nextStopContainer" style="height: 74%; width: 100%; font-size: 75px;display: inline-flex; font-family: 'myriad-pro-condensed', sans-serif;">
                                    <span id="nextStopDE" style="padding-right: 15px;"></span>
                                    <i id="nextStopEN" style="color: #666666;padding-right: 15px;"></i>
                                    <img id="nextStopRVFV" style="height: 60px;align-self: center; display:none; filter: brightness(33%) contrast(58%);" src="icons/RVFV.svg"></img>
                                </div>
                            </div>
                        </div>
                        <div id="stationDetails" style="display: none; height: 276px; background-color: #E6E6E6;">
                            
                        </div>
                        <div id="welcomeScreen" style="display: none; height: 276px; background-color: #E6E6E6; font-family: 'myriad-pro', sans-serif; font-size: 30px;">
                            <div style="left: 55px;position: relative;top: 46px;">
                                <span>Herzlich willkommen in der Linie <span id="welcomeLineNumber"></span><br><span id="welcomeTenantDE">Die S-Bahn München</span> wünscht Ihnen eine gute Fahrt.</span>
                                <br>
                                <i style="color: #666666;top: 24px;position: relative;">We would like to welcome all passengers to<br><span id="welcomeTenantEN">S-Bahn München</span> and wish you a pleasant journey!</i>
                            </div>
                        </div>
                        <div id="stationList" style="display: block; height: 276px; background-color: #E6E6E6; overflow: auto; scrollbar-width: none; -ms-overflow-style: none;">
                            
                        </div>
                    </div>
                    <div style="width: 745px; background-color: black; height: 100%;">
                        <video id="infotainmentPlayer" autoplay muted width="100%" onended="advanceInfotainmentQueue()"></video>
                    </div>
                </div>
                <div style="height: 116px; vertical-align: bottom; background-image: linear-gradient(to right, #004679, #0F86D8); display: flex; flex-direction: column;">
                    <div style="height: 89.6%;  display: flex;align-items: center;">
                        <svg style="display: table-cell; width: 147px; padding: 25px;padding-left: 30px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1060 465"> <g> <path id="lineNumberFill" fill="#963833" d="M 787.5,0 H 272.173 C 143.773,0 0,104.088 0,232.488 0,360.888 143.773,464.976 272.173,464.976 H 787.5 c 128.4,0 272.174,-104.088 272.174,-232.488 C 1059.674,104.088 915.901,0 787.5,0 Z" style="fill:#008e4e;fill-opacity:1" /> <text xml:space="preserve" style="font-style:normal;font-variant:normal;font-weight:900;font-stretch:normal;font-size:483.517px;font-family:Arial;-inkscape-font-specification:'Arial, Heavy';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;text-anchor:middle;dominant-baseline:middle;display:table-cell;fill:#ffffff;" x="530.66327" y="280.17865" id="lineNumberText"><tspan id="lineNumberTextContent" x="530.66327" y="280.17865">S</tspan></text></g></svg>
                        
                        <span id="finalDestinationDE" style="font-family: 'myriad-pro-light', sans-serif; color: #ffffff;  font-size: 77px;font-style: normal;font-weight: 700;letter-spacing: 1.2px; padding-right: 15px;"></span>
                        <i id="finalDestinationEN" style="font-family: 'myriad-pro-light', sans-serif; font-size: 77px; color: #ffffff;"></i>
                        <img id="finalDestinationRVFV" style="height: 60px; padding: 10px; display:none;" src="icons/RVFV.svg"></img>

                        <p id="digitalClock" style="font-family: 'myriad-pro', sans-serif; color: #ffffff;  display: table-cell;font-size: 40px;font-style: normal;font-weight: 700; padding-right: 30px; text-align: right;margin-left: auto;">00<span style="opacity: 0;">:</span>00</p>
                        <script>
                            function updateClock() {
                                const date = new Date();
                                let h = date.getHours();
                                let m = date.getMinutes();
                                let delimiter = '<span style="opacity: 1;">:</span>';

                                if(h < 10) {h = "0" + h};
                                if(m < 10) {m = "0" + m};
                                if(date.getSeconds() % 2 === 0) {delimiter = '<span style="opacity: 0;">:</span>'}

                                let time = h + delimiter + m;

                                document.getElementById("digitalClock").innerHTML = time;
                                
                                setTimeout(updateClock, 1000);
                            }
                            
                            function advanceInfotainmentQueue() {
                                currentInfotainmentIndex++;
                                if(currentInfotainmentIndex > infotainmentQueue.length - 1) {
                                    currentInfotainmentIndex = 0;
                                }
                                
                                var player = document.getElementById("infotainmentPlayer");
                                player.attributes = "";
                                player.setAttribute("src", infotainmentQueue[currentInfotainmentIndex]);
                            }

                            updateClock();
                            advanceInfotainmentQueue()
                        </script>
                    </div>
                    <div class="lineStrokeColoured" style="height: 10.4%; align-self: flex-end; width: 100%; background-color: #008E4E;"></div>
                </div>
            </div>

            <img id="fullScreenError" src="./references/InnenraumFIS_CompleteFailure.png" style="position: absolute; width: 1900px; height: 535px;">

            <!-- <img src="https://www.s-bahn-muenchen-magazin.de/06_Juni%202019/Modernisierung%20Anschluss%C3%BCbersicht/image-thumb__325__articleTextImage/S-Bahn-Muenchen_Header-3_v2.jpg.png" style="opacity: 40%; position: absolute; width: 1900px;"> -->
            <!-- <img src="./references/S3TrudRefrence.png" style="opacity: 40%; position: absolute; width: 1900px;"> -->
        </main>

        <div class="data-area" style="padding: 1vw; padding-top: 0;">
            <h1>Settings</h1>
            <div style="display: table;">
                <p style="display: table-cell;">Train ID</p>
                <div style="display: table-cell;display: flex;">
                    <input type="text" id="input_dbgTrainID">
                    <input type="submit" value="Submit" onclick="debugSearchTrainID()">
                </div>
            </div>
        </div>

        <script type='text/javascript'> // Generate dynamic OpenGraph tags
            document.addEventListener("DOMContentLoaded", () => {
                const socket = new WebSocket('wss://api.geops.io/realtime-ws/v1/?key=5cc87b12d7c5370001c1d655112ec5c21e0f441792cfc2fafe3e7a1e');
                const paramTrainId = new URLSearchParams(document.location.search).get("trainid");
    
                socket.onopen = function(e) {
                    if(paramTrainId != null) {
                        socket.send(`GET trajectory`);
                    }
                }
    
                socket.onmessage = function(e) {
                    const data = JSON.parse(e.data).content;
                    console.log(data);
                    
                    if(data.properties != undefined) { // Check for undefined to avoid an error when the initial 'open' is sent
                        if(data.properties.train_id == paramTrainId) {
                            socket.close(); // Close the socket when the specific train_id has been found
                            
                            const title = data.properties.train_number;
                            const embedColor = data.properties.line.stroke;

                            var rakeOutput = '';
                            if(data.properties.rake == null) {
                                rakeOutput = "Unbekannter Zugverband"
                            }
                            else {
                                const rakeArray = data.properties.rake.split(";");
                                rakeArray.forEach(UIC => {
                                    if(UIC != "0" && UIC.length == 12) {
                                        if(rakeOutput != '') {
                                            rakeOutput += " + "
                                        }
                                        rakeOutput += UIC.substring(5, 8) + " " + UIC.substring(8, 11) + "-" + UIC.charAt(11);
                                    }
                                });
                            }
                            const description = rakeOutput + " auf der " + data.properties.line.name;
                                                                                    
                            document.head.append('<meta property="og:title" content="' +  title + '">' );
                            document.head.append('<meta property="og:description" content="' +  description + '">' );
                            document.head.append('<meta name="theme-color" content="' + embedColor + '">');
                        }
                    }
                }
            });
        </script>   
    </body>
</html>